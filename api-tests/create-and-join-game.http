### Create and Join Game Workflow - Chained Requests
### Variables loaded from .env file (gitignored, safe for tokens)
### Pre-request script reads .env file before every request (no caching!)
###
### This demonstrates chaining: Create a game, extract the gameId from the response,
### then automatically join that game in the next request.

@gameId = placeholder-game-id

### Step 1: Create Game - Extract gameId from response
< {%
    // Pre-request script: Read .env file and load variables before EVERY request
    // This runs fresh each time to avoid any caching issues
    const fs = require('fs');
    const path = require('path');
    
    // Find .env file in workspace root (up from api-tests/)
    // Use realpathSync to ensure we get the actual file path
    const scriptDir = path.dirname(process.env.REST_CLIENT_FILE || __dirname || '');
    const workspaceRoot = path.resolve(scriptDir, '..');
    const envPath = path.join(workspaceRoot, '.env');
    
    // Force fresh read - clear cache by using realpath and reading directly
    let envPathResolved;
    try {
        envPathResolved = fs.realpathSync(envPath);
    } catch (e) {
        envPathResolved = envPath;
    }
    
    if (fs.existsSync(envPathResolved)) {
        // Read file fresh - no caching
        const envContent = fs.readFileSync(envPathResolved, 'utf8');
        const lines = envContent.split('\n');
        
        let tokenFound = false;
        lines.forEach(line => {
            const trimmed = line.trim();
            // Skip comments and empty lines
            if (trimmed && !trimmed.startsWith('#')) {
                const match = trimmed.match(/^([A-Z_]+)=(.+)$/);
                if (match) {
                    const key = match[1];
                    const value = match[2].trim();
                    // Set as global variable for use in request
                    client.global.set(key, value);
                    if (key === 'ID_TOKEN') {
                        tokenFound = true;
                        // Log token info (first/last 20 chars for debugging, not full token)
                        const tokenPreview = value.length > 40 
                            ? value.substring(0, 20) + '...' + value.substring(value.length - 20)
                            : value.substring(0, 20) + '...';
                        client.log(`[PRE-REQUEST] Loaded ID_TOKEN from .env: ${tokenPreview} (length: ${value.length})`);
                    }
                }
            }
        });
        
        if (!tokenFound) {
            client.log('[PRE-REQUEST] WARNING: ID_TOKEN not found in .env file!');
        }
    } else {
        client.log(`[PRE-REQUEST] ERROR: .env file not found at ${envPathResolved}`);
    }
%}

POST {{API_URL}}/games
Authorization: Bearer {{ID_TOKEN}}
Content-Type: application/json

{
  "playerName": "Test Player"
}

> {%
    // Extract gameId from the response and store it globally
    if (response.status === 200) {
        const responseBody = JSON.parse(response.body);
        const gameId = responseBody.gameId || responseBody.game?.gameId;
        if (gameId) {
            client.global.set("gameId", gameId);
            client.log("✓ Game created! GameId stored: " + gameId);
        } else {
            client.log("⚠ Warning: Could not extract gameId from response");
            client.log("Response body: " + response.body);
        }
    } else {
        client.log("✗ Error creating game: " + response.status + " - " + response.body);
    }
%}

###

### Step 2: Join Game - Uses the gameId extracted from the previous request
### NOTE: Run Step 1 first to set the gameId variable!
< {%
    // Pre-request script: Read .env file and load variables before EVERY request
    // This runs fresh each time to avoid any caching issues
    const fs = require('fs');
    const path = require('path');
    
    // Find .env file in workspace root (up from api-tests/)
    // Use realpathSync to ensure we get the actual file path
    const scriptDir = path.dirname(process.env.REST_CLIENT_FILE || __dirname || '');
    const workspaceRoot = path.resolve(scriptDir, '..');
    const envPath = path.join(workspaceRoot, '.env');
    
    // Force fresh read - clear cache by using realpath and reading directly
    let envPathResolved;
    try {
        envPathResolved = fs.realpathSync(envPath);
    } catch (e) {
        envPathResolved = envPath;
    }
    
    if (fs.existsSync(envPathResolved)) {
        // Read file fresh - no caching
        const envContent = fs.readFileSync(envPathResolved, 'utf8');
        const lines = envContent.split('\n');
        
        let tokenFound = false;
        lines.forEach(line => {
            const trimmed = line.trim();
            // Skip comments and empty lines
            if (trimmed && !trimmed.startsWith('#')) {
                const match = trimmed.match(/^([A-Z_]+)=(.+)$/);
                if (match) {
                    const key = match[1];
                    const value = match[2].trim();
                    // Set as global variable for use in request
                    client.global.set(key, value);
                    if (key === 'ID_TOKEN') {
                        tokenFound = true;
                        // Log token info (first/last 20 chars for debugging, not full token)
                        const tokenPreview = value.length > 40 
                            ? value.substring(0, 20) + '...' + value.substring(value.length - 20)
                            : value.substring(0, 20) + '...';
                        client.log(`[PRE-REQUEST] Loaded ID_TOKEN from .env: ${tokenPreview} (length: ${value.length})`);
                    }
                }
            }
        });
        
        if (!tokenFound) {
            client.log('[PRE-REQUEST] WARNING: ID_TOKEN not found in .env file!');
        }
    } else {
        client.log(`[PRE-REQUEST] ERROR: .env file not found at ${envPathResolved}`);
    }
%}

POST {{API_URL}}/games/{{gameId}}/join
Authorization: Bearer {{ID_TOKEN}}
Content-Type: application/json

{
  "playerName": "Second Player"
}

> {%
    const storedGameId = client.global.get("gameId");
    if (response.status === 200) {
        client.log("✓ Successfully joined game: " + storedGameId);
    } else {
        client.log("✗ Error joining game: " + response.status);
        client.log("Response: " + response.body);
        if (!storedGameId) {
            client.log("⚠ Warning: gameId variable not set. Make sure to run Step 1 first!");
        }
    }
%}
