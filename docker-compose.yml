# version is obsolete in newer Docker Compose versions

services:
  app:
    # Use pre-built image or build if not exists
    # Image is environment-agnostic - all config comes from runtime env vars
    # Contains both the game and the editor
    image: syniad-app-local:latest
    platform: linux/amd64 # Target Lambda platform (works on ARM via emulation)
    build:
      context: .
      dockerfile: Dockerfile
      platforms:
        - linux/amd64
      # No build args needed - image is environment-agnostic
    container_name: syniad-app-local
    ports:
      - "3000:8080"
    # Override ENTRYPOINT and CMD for local development - don't use Lambda Web Adapter
    entrypoint: []
    command: ["node", "server.js"]
    environment:
      # Runtime environment variables from root .env file
      NODE_ENV: ${NODE_ENV:-production}
      PORT: ${PORT:-8080}
      HOSTNAME: ${HOSTNAME:-0.0.0.0}
      NEXT_TELEMETRY_DISABLED: ${NEXT_TELEMETRY_DISABLED:-1}
      # Application URLs (local)
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:3000}
      NEXT_PUBLIC_FRONTEND_URL: ${NEXT_PUBLIC_FRONTEND_URL:-http://localhost:3000}
      NEXTAUTH_URL: ${NEXTAUTH_URL:-http://localhost:3000}
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}
      NEXT_PUBLIC_ASSET_PREFIX: ${NEXT_PUBLIC_ASSET_PREFIX:-}
      NEXT_PUBLIC_BASE_PATH: ${NEXT_PUBLIC_BASE_PATH:-}
      # Cognito Configuration (from .env - set by deploy-local.sh)
      COGNITO_USER_POOL_ID: ${COGNITO_USER_POOL_ID}
      COGNITO_CLIENT_ID: ${COGNITO_CLIENT_ID}
      COGNITO_CLIENT_SECRET: ${COGNITO_CLIENT_SECRET:-}
      COGNITO_REGION: ${COGNITO_REGION}
      COGNITO_DOMAIN: ${COGNITO_DOMAIN}
      BETTER_AUTH_SECRET: ${BETTER_AUTH_SECRET}
      # AWS Configuration for DynamoDB
      # Mount AWS credentials from host for DynamoDB access
      AWS_REGION: ${AWS_REGION:-us-east-1}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
      AWS_SESSION_TOKEN: ${AWS_SESSION_TOKEN:-}
      AWS_PROFILE: ${AWS_PROFILE:-}
      # Set AWS credentials file location for nextjs user (container runs as nextjs, not root)
      AWS_SHARED_CREDENTIALS_FILE: /home/nextjs/.aws/credentials
      AWS_CONFIG_FILE: /home/nextjs/.aws/config
      # DynamoDB Table Names (from .env - set by deploy-local.sh to dev tables)
      GAMES_TABLE: ${GAMES_TABLE}
      PLAYER_GAMES_TABLE: ${PLAYER_GAMES_TABLE}
      SCENARIOS_TABLE: ${SCENARIOS_TABLE}
      # WebSocket Configuration (from .env - set by deploy-local.sh)
      WEBSOCKET_URL: ${WEBSOCKET_URL:-}
      # WebSocket broadcast configuration (for API routes to broadcast messages)
      CONNECTIONS_TABLE: ${CONNECTIONS_TABLE:-}
      WEBSOCKET_ENDPOINT: ${WEBSOCKET_ENDPOINT:-}
    volumes:
      # Mount AWS credentials from host so container can access DynamoDB
      # Container runs as nextjs user (UID 1001), so mount to their home directory
      # Use ${HOME} which Docker Compose will expand from the host environment
      - ${HOME}/.aws:/home/nextjs/.aws:ro
    restart: unless-stopped
